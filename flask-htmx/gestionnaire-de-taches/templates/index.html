<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion de t√¢ches - {{ current_planning_name }}</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        :root {
            --slot-width: {{ slot_width }}px;
            --row-height: {{ row_height }}px;
            --header-height: {{ header_height }}px;
            --num-slots: {{ num_slots }};
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-actions">
            <h1>Gestion de t√¢ches - {{ current_planning_name }}</h1>
            <div class="action-buttons">
                {% if current_database_url_odoo %}
                <button id="open-odoo-btn" class="btn btn-primary" onclick="window.open('{{ current_database_url_odoo }}', '_blank')" title="Ouvrir Odoo">
                    üè¢ Odoo
                </button>
                {% endif %}
                <button id="change-database-btn" class="btn btn-secondary" onclick="window.location.href='{{ url_for('change_database') }}'">
                    üîÑ Changer de base
                </button> 
                <button id="change-planning-btn" class="btn btn-secondary" onclick="window.location.href='{{ url_for('change_planning') }}'">
                    üìã Changer de planning
                </button>
                 <button id="reload-data-btn" class="btn btn-secondary">
                    ‚Üª Recharger les donn√©es
                </button>
                <span id="status-text" class="status-text">
                    {{ operators|length }} op√©rateurs - {{ affairs|length }} affaires
                </span>
            </div>
        </div>
        
        <div class="planning-container">
            <!-- Conteneur global avec scroll horizontal unique -->
            <div class="planning-scroll-container">
                <!-- En-t√™te avec les cr√©neaux horaires -->
                <div class="time-header">
                    <div class="operator-name-header">Op√©rateur</div>
                    <div class="time-header-slots">
                        <div class="time-header-slots-inner">
                            <!-- Ligne des mois -->
                            <div class="header-row header-months">
                                {% for month in months %}
                                    <div class="header-cell month-cell" style="width: calc({{ month.span }} * var(--slot-width));">
                                        {{ month.name }}
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Ligne des semaines -->
                            <div class="header-row header-weeks">
                                {% for week in weeks %}
                                    <div class="header-cell week-cell" style="width: calc({{ week.span }} * var(--slot-width));">
                                        {{ week.name }}
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Ligne des jours -->
                            <div class="header-row header-days">
                                {% for day in days %}
                                    <div class="header-cell day-cell{% if day.day_name in ['Samedi', 'Dimanche'] %} weekend-header{% endif %}">
                                        <div class="day-date">{{ day.day_name[0] }}{{ day.date }}</div>
                                    </div>
                                {% endfor %}
                            </div>
                            
                            <!-- Ligne AM/PM -->
                            <div class="header-row header-periods">
                                {% for slot in time_slots %}
                                    <div class="header-cell period-cell{% if slot.day_name in ['Samedi', 'Dimanche'] %} weekend-header{% endif %}{% if slot.is_vacation %} vacation-header{% endif %}">{{ slot.period }}</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Zone de contenu avec d√©filement vertical -->
                <div class="operators-container">
                    <!-- Lignes des op√©rateurs -->
                    {% for operator in operators %}
                    <div class="operator-row" data-operator-id="{{ operator.id }}">
                        <div class="operator-name">
                            {{ operator.name }}
                        </div>
                        
                        <!-- Grille des cr√©neaux pour cet op√©rateur -->
                        <div class="time-slots-container">
                            <div class="time-slots-wrapper">
                                {% for slot in time_slots %}
                                <div class="time-slot{% if slot.day_name in ['Samedi', 'Dimanche'] %} weekend-slot{% endif %}{% if slot.is_vacation %} vacation-slot{% endif %}{% if operator_absences[operator.id][slot.slot] %} absence-slot{% endif %}" 
                                     data-operator-id="{{ operator.id }}" 
                                     data-slot="{{ slot.slot }}"
                                     ondrop="handleDrop(event)" 
                                     ondragover="handleDragOver(event)">
                                </div>
                                {% endfor %}
                                
                                <!-- T√¢ches pour cet op√©rateur -->
                                {% for task in tasks %}
                                {% if task.operator_id == operator.id %}
                                {% set affair = affairs|selectattr("id", "equalto", task.affaire_id)|first %}
                                {# Utiliser is_date_prevue de l'OF pour la comparaison #}
                                {% set is_late = task.end_date and task.is_date_prevue and task.end_date.date() > task.is_date_prevue %}
                                <div class="task{% if task.is_composants_non_disponibles and task.is_composants_non_disponibles != 'None' and task.is_composants_non_disponibles != 'False' and task.is_composants_non_disponibles|string|trim != '' %} task-missing-components{% endif %}{% if is_late %} task-late{% endif %}" 
                                     data-task-id="{{ task.id }}"
                                     data-operator-id="{{ task.operator_id }}"
                                     data-start-slot="{{ task.start_slot }}"
                                     data-duration="{{ task.duration }}"
                                     data-affair-id="{{ task.affaire_id }}"
                                     data-title="{{ task.name | e }}"
                                     data-operation-name="{{ task.operation_name | e }}"
                                     data-product-qty="{{ task.product_qty | e }}"
                                     data-derniere-date-prevue="{{ task.is_derniere_date_prevue | e }}"
                                     data-date-prevue-of="{{ task.is_date_prevue.strftime('%Y-%m-%d') if task.is_date_prevue else '' }}"
                                     data-end-date="{{ task.end_date.strftime('%Y-%m-%d %H:%M:%S') if task.end_date else '' }}"
                                     data-employe-ids-txt="{{ task.is_employe_ids_txt | e }}"
                                     data-composants-non-disponibles="{{ task.is_composants_non_disponibles | e }}"
                                     data-date-prevue="{{ task.is_date_prevue | e }}"
                                     data-affair-name="{{ affair.name | e }}"
                                     style="background-color: {{ affair.color }}; 
                                            left: calc({{ task.start_slot }} * var(--slot-width)); 
                                            width: calc({{ task.duration }} * var(--slot-width) - 2px);"
                                     draggable="true"
                                     ondragstart="handleDragStart(event)"
                                     onmouseenter="showTooltip(event)"
                                     onmouseleave="hideTooltip(event)"
                                     tabindex="0"
                                     onkeydown="handleKeyDown(event)">
                                    
                                    <div class="task-content">
                                        <div class="task-title">{{ task.name }}</div>
                                        {% if task.product_qty %}
                                        <div class="task-quantity">
                                            Qt : {{ task.product_qty | round | int }}{% if task.is_derniere_date_prevue %} - 
                                            Date pr√©vue : {{ task.is_derniere_date_prevue.strftime('%d/%m/%y') if task.is_derniere_date_prevue else '' }}{% endif %}</div>
                                        {% endif %}
                                        {% if task.operation_name %}
                                        <div class="task-operation">{{ task.operation_name }}</div>
                                        {% endif %}
                                        <div class="task-affair">Affaire : {{ affair.name }}{% if task.production_name %} - OF : {{ task.production_name }}{% endif %}</div>
                                    </div>
                                    
                                    <!-- Poign√©e de redimensionnement -->
                                    <div class="resize-handle resize-right" 
                                         onmousedown="startResize(event, 'right')"
                                         onclick="event.stopPropagation()"></div>
                                </div>
                                {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <!-- Barre de d√©filement horizontal en bas -->
                <div class="horizontal-scrollbar">
                    <div class="horizontal-scrollbar-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tooltip pour les t√¢ches -->
    <div id="task-tooltip" class="task-tooltip">
        <div class="task-tooltip-content">
            <div class="task-tooltip-title"></div>
            <div class="task-tooltip-detail"></div>
        </div>
    </div>

    <script>
        // Configuration pour l'ouverture des t√¢ches dans Odoo
        window.taskOdooConfig = {
            urlTemplate: '{{ current_database_url_tache_odoo }}'
        };
    </script>
    
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>
